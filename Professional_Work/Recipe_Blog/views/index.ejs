<!-- include the code from partials (banner with nav) -->
<%- include("partials/header.ejs") %>

<body>   
<!-- Recipe Posts -->

<h1 class="makeAPost">Recipe Posts</h1>
    <div class="RecipePostDiv">

        <% if (locals.allPosts.length === 0) { %>
            <h2>Be the first to post!</h2>
        <% } %>

        <% if (locals.allPosts) { for (let i = 0; i < allPosts.length; i++) { %>
            <div class="postBox">
            <!-- top row: date, save -->
            <div class="topRow">
                <% 
                    const d = new Date(allPosts[i].time);
                    const formatted = d.toLocaleString('en-US', { 
                        weekday: 'short', month: 'short', day: '2-digit', year: 'numeric', 
                        hour: '2-digit', minute: '2-digit', hour12: false 
                        }).replace(',', '');
            %>
            <p class="date"><%= formatted %></p><br>

            <div class="buttonGroup">
                <% if (locals.currentUserId) { %>
                    <form action="/saveRecipe" method="POST">
                        <input type="hidden" name="recipeId" value="<%= allPosts[i].id %>">
                        <button type="submit" id="deletebtn">Save Recipe</button>
                    </form>
                <% } %>
            </div>
            </div>

            <!-- Creator and Title -->
            <p class="name"><strong><%= allPosts[i].name %></strong></p>
            <h3 class="title"><%= allPosts[i].title %></h3>

            <!-- Image -->
            <% if (allPosts[i].image_path) { %>
            <img src="<%= allPosts[i].image_path %>" alt="Post image" class="postImage">
            <% } %>

            <!-- Ingredients -->
            <% if (allPosts[i].ingredients && allPosts[i].ingredients.trim() !== "") { %>
            <div class="ingredientsBlock">
                <h4>Ingredients</h4>
                <ul>
                <% allPosts[i].ingredients.split('\n').forEach(function(line) { %>
                    <li><%= line.trim() %></li>
                <% }); %>
                </ul>
            </div>
            <% } %>

            <!-- Instructions / Content -->
            <% if (allPosts[i].content) { %>
            <div class="instructionsBlock">
                <h4>Instructions</h4>
                <p><%= allPosts[i].content %></p>
            </div>
            <% } %>

            <!-- Tags and Extra Info -->
            <div class="metaInfo">
            <% if (allPosts[i].tag) { %>
                <span class="tag"><%= allPosts[i].tag %></span>
            <% } %>
            <% if (allPosts[i].cuisineTag) { %>
                <span class="tag"><%= allPosts[i].cuisineTag %></span>
            <% } %>
            <% if (allPosts[i].mealType) { %>
                <span class="tag"><%= allPosts[i].mealType %></span>
            <% } %>
            </div>

            <!-- Stats -->
            <div class="statsRow">
            <p>Cook Time: <%= allPosts[i].cook_time %> min</p>
            <p>Difficulty: <%= allPosts[i].difficulty %> / 5</p>
            </div>

            <!-- notes -->
            <% if (allPosts[i].notes && allPosts[i].notes.trim() !== "") { %>
                <div class="notes">
                    <h4>Notes</h4>
                    <p><%- allPosts[i].notes.replace(/</g, '&lt;').replace(/>/g, '&gt;') %></p>
                </div>
            <% } %>

            <!-- stats -->
            <div class="statsRow">
                <% if (allPosts[i].avg_rating) { %>
                    <h4>Rating: <%= allPosts[i].avg_rating.toFixed(1) %>★
                    (<%= allPosts[i].num_reviews %> reviews)</h4>
                <% } else { %>
                    <h4>No ratings yet</h4>
                <% } %>
            </div>

            <!-- ratings -->
            <div class="commentSection">
                <div class="ratingsHeader">
                    <span>Ratings</span>
                    <% if (allPosts[i].ratings && allPosts[i].ratings.length > 0) { %>
                        <button type="button" class="toggleRatingsBtn">Show Ratings</button>
                    <% } %>
                </div>

                <div class="ratingsContainer" style="display:none;">
                    <% allPosts[i].ratings.forEach(c => { %>
                        <p>
                            <strong><%= c.user_id %></strong>
                            <% if (c.comment && c.comment.trim() !== "") { %>
                                : <%= c.comment %>
                            <% } %>
                            (<%= c.rating %>★)
                        </p>
                    <% }); %>
                </div>
            </div>

            <!-- rating form -->
            <% if (currentUserId) { %>
            <form action="/rateRecipe" method="POST" class="ratingForm">
                <input type="hidden" name="recipe_id" value="<%= allPosts[i].id %>">

                <label>Rate this recipe:</label>
                <select name="rating" required>
                <option value="">Choose</option>
                <% for (let r = 1; r <= 5; r++) { %>
                    <option value="<%= r %>"><%= r %></option>
                <% } %>
                </select>

                <textarea name="comment" placeholder="Leave a remark (optional)" rows="2" style="margin-left: 40px;"></textarea>

                <button type="submit" class="saveBtn">Submit Rating</button>
            </form>
            <% } %>

            <!-- comment threads -->
            <div class="commentSection">
                <div class="commentHeader">
                    <span>Comments</span>
                    <% if (allPosts[i].threaded_comments && allPosts[i].threaded_comments.length > 0) { %>
                        <button type="button" class="toggleCommentsBtn">Show Comments</button>
                    <% } %>
                </div>

                <div class="commentsContainer" style="display:none;">
                    <% if (allPosts[i].threaded_comments && allPosts[i].threaded_comments.length > 0) { %>
                        <%- include('partials/commentThread', {
                            comments: allPosts[i].threaded_comments,
                            parent: null,
                            level: 0,
                            recipeId: allPosts[i].id,
                            currentUserId: currentUserId
                        }) %>
                    <% } else { %>
                        <p>No comments yet.</p>
                    <% } %>
                </div>
            </div>


            <!-- Comment form -->
            <% if (currentUserId) { %>
            <form action="/commentCreate" method="POST" style="margin-top:1rem;">
                <input type="hidden" name="recipe_id" value="<%= allPosts[i].id %>">
                <textarea name="comment" placeholder="Write a comment..." rows="2" style="width:95%;"></textarea>
                <button type="submit" class="saveBtn" style="margin-top:0.4rem;">Post Comment</button>
            </form>
            <% } %>
        </div>
        <% } } %>

        <script>
            document.addEventListener('DOMContentLoaded', () => {
                // Toggle Comments
                document.querySelectorAll('.toggleCommentsBtn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const container = btn.closest('.commentSection').querySelector('.commentsContainer');
                        if (container.style.display === 'none') {
                            container.style.display = 'block';
                            btn.textContent = 'Hide Comments';
                        } else {
                            container.style.display = 'none';
                            btn.textContent = 'Show Comments';
                        }
                    });
                });

                // Toggle Ratings
                document.querySelectorAll('.toggleRatingsBtn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const container = btn.closest('.commentSection').querySelector('.ratingsContainer');
                        if (container.style.display === 'none') {
                            container.style.display = 'block';
                            btn.textContent = 'Hide Ratings';
                        } else {
                            container.style.display = 'none';
                            btn.textContent = 'Show Ratings';
                        }
                    });
                });
            });
        </script>
    </div>
</body>

</html>
